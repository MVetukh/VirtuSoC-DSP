# DSP-модуль: FIR-ускоритель

## 1. Обзор
Аппаратный FIR-ускоритель реализует фильтрацию последовательности фиксированной точности. Управление по **AXI4-Lite**, потоковые данные — **AXI4-Stream** (вход/выход). Поддерживаются два сценария:
- **Стримовый** (через DMA): mem→DMA→FIR→DMA→mem — для больших массивов.
- **MMIO-окно**: регистры `DATA_IN/OUT` — для отладки и коротких тестов.

## 2. Алгоритм и формат данных
- **Архитектура:** FIR, прямая форма (транспонированная), линейно-фазовый.
- **Фиксированная точность (по умолчанию):**
  - выборки: `Q1.15` (signed 16-bit),
  - коэффициенты: `Q1.15` (signed 16-bit),
  - аккумулятор: 32-бит (с насыщением),
  - выход: округление к `Q1.15` (с насыщением).
- **Параметры:** число тапов `N` (до 256 по умолчанию), режимы округления/сжатия.

> Примечание: VALID/READY семантика на входе/выходе соответствует AXI4-Stream. :contentReference[oaicite:9]{index=9}

## 3. Интерфейсы

### 3.1. AXI4-Lite (управление)
- `s_axi_aw*`, `s_axi_w*`, `s_axi_b*`, `s_axi_ar*`, `s_axi_r*`, `aclk`, `aresetn`.

### 3.2. AXI4-Stream In/Out (данные)
- **Вход**: `s_axis_tdata[15:0]`, `s_axis_tvalid`, `s_axis_tready`, `s_axis_tlast` (опционально).
- **Выход**: `m_axis_tdata[15:0]`, `m_axis_tvalid`, `m_axis_tready`, `m_axis_tlast` (опционально).

### 3.3. Прерывание
- `irq_o` → PLIC (`DONE`, `ERR_*`).

## 4. Карта регистров (база модуля = `DSP_BASE`, 32-битная шина)

| Offset | Имя          | Тип   | Reset | Описание |
|-------:|--------------|-------|------:|---------|
| 0x000  | `CTRL`       | `rw`  | 0x0   | Бит0 `START`, Бит1 `ABORT`, Бит2 `SOFT_RESET`, Бит3 `MMIO_MODE` (1=исп. `DATA_IN/OUT`) |
| 0x004  | `STATUS`     | `ro`  | 0x0   | Бит0 `DONE`, Бит1 `BUSY`, Бит2 `ERR_CFG`, Бит3 `ERR_OVF` |
| 0x008  | `CFG`        | `rw`  | 0x0   | Бит[3:0] `ROUND` (0=truncate, 1=round-to-nearest), Бит4 `SATURATE`, Бит[15:8] `SCALE` |
| 0x00C  | `TAPS_NUM`   | `rw`  | 0x0   | Количество тапов `N` (1..256) |
| 0x010  | `IRQ_EN`     | `rw`  | 0x0   | Маска прерываний (`DONE`, `ERR_*`) |
| 0x014  | `IRQ_STATUS` | `w1c` | 0x0   | Флаги IRQ (запись «1» очищает соответствующий бит) |
| 0x020  | `COEFF_W`    | `wo`  | —     | Окно загрузки коэффициентов: запись 16-бит значения в выбранный индекс |
| 0x024  | `COEFF_IDX`  | `rw`  | 0x0   | Индекс текущего коэффициента (0..N-1) |
| 0x028  | `COEFF_COMMIT`| `wo` | —     | Фиксация новой таблицы (двойной буфер) |
| 0x030  | `DATA_IN`    | `wo`  | —     | (MMIO-режим) Ввод одной выборки |
| 0x034  | `DATA_OUT`   | `ro`  | —     | (MMIO-режим) Чтение выходной выборки |
| 0x038  | `LEN`        | `rw`  | 0x0   | Длина блока (в выборках) для DMA/стриминга |
| 0x03C  | `CMD`        | `wo`  | —     | Команда ускорителю (см. §5) |
| 0x040  | `VERSION`    | `ro`  | —     | Версия IP (например, `0x0001_0000`) |
| 0x044  | `ID`         | `ro`  | —     | Идентификатор (например, ASCII `'FIR1'`) |

> Все регистры — 32-бит шириной данных; поля/форматы приведены ниже.

### 4.1. Битовые поля

**`CTRL` (0x000, rw)**  
| Бит | Имя         | Описание                           |
|----:|-------------|------------------------------------|
| 0   | START       | Запуск обработки блока (автосброс) |
| 1   | ABORT       | Аварийная остановка                |
| 2   | SOFT_RESET  | Сброс внутренних состояний         |
| 3   | MMIO_MODE   | 1=исп. регистры `DATA_IN/OUT`      |

**`STATUS` (0x004, ro)**  
| Бит | Имя    | Описание                                   |
|----:|--------|--------------------------------------------|
| 0   | DONE   | Завершение обработки блока                  |
| 1   | BUSY   | Ускоритель занят                            |
| 2   | ERR_CFG| Ошибка конфигурации (напр., `N=0`)          |
| 3   | ERR_OVF| Переполнение/ненормальная ситуация          |

**`CFG` (0x008, rw)**  
| Поле     | Биты  | Описание                                      |
|----------|-------|-----------------------------------------------|
| ROUND    | 3:0   | 0=truncate, 1=round-to-nearest                |
| SATURATE | 4     | 1=насыщение при выходе за диапазон            |
| SCALE    |15:8   | Пост-масштабирование (арифм. сдвиг вправо)    |

**`TAPS_NUM` (0x00C, rw)**  
Число тапов `N` (1..256). Переключение на новые коэффициенты происходит после `COEFF_COMMIT`.

**`COEFF_*` (0x020..0x028)**  
Загрузка коэффициентов:  
1) записать `COEFF_IDX = i`,  
2) записать `COEFF_W = (int16_t)h[i]`,  
3) после всех записей — `COEFF_COMMIT` для атомарной смены банка.

**`CMD` (0x03C, wo)** — см. §5.

**`IRQ_*` (0x010..0x014)**  
Маскирование и обслуживание прерываний. Запись `1` в `IRQ_STATUS` очищает соответствующий флаг.

## 5. Формат команд управления ускорителем
Регистр `CMD` (write-only, 32-бит) принимает «опкоды»:

| Поле     | Биты  | Значение |
|----------|-------|----------|
| `OP`     | 7:0   | Код операции |
| `ARG`    |31:8   | Необязательный аргумент (семантика зависит от `OP`) |

Поддерживаемые `OP`:
- `0x01` **LOAD_COEFF_SEQ** — сигнализирует, что последовательная загрузка коэффициентов завершена (эквивалент `COEFF_COMMIT`).
- `0x02` **START_BLOCK** — запустить обработку блока длиной `LEN`.
- `0x03` **ABORT** — немедленно остановить.
- `0x04` **RESET** — мягкий сброс (равносилен `CTRL.SOFT_RESET`).
- `0x10` **SET_SCALE** — установить масштаб (`ARG[7:0]` → `CFG.SCALE`).
- `0x11` **SET_ROUND** — установить режим округления (`ARG[3:0]` → `CFG.ROUND`).

> В типовом драйвере достаточно `CTRL.START`/`CTRL.SOFT_RESET` и `COEFF_*`. Регистр `CMD` удобен для скриптов/экспериментов.

## 6. Тайминг и производительность
- **Латентность:** ≈ `N + Lpipe` тактов до первого валидного выхода (при 1 семпле/такт).
- **Сквозная скорость:** до 1 выборки/такт при `tready=1`. Узкие места — DMA/память.
- **Численная устойчивость:** рекомендуются нормированные коэффициенты (|h|<1), скейл после аккумуляции.

## 7. Примеры

### 7.1. Мини-скелет Verilog (AXI4-Stream datapath)
```verilog
always @(posedge aclk) begin
  if (!aresetn) begin
    // reset state
  end else begin
    // handshake: accept when s_axis_tvalid && s_axis_tready
    // produce   when m_axis_tready  && data_valid_internal
  end
end